## 题目

读题找关键词  smb协议   获取共享列表    识别V1和V2版本服务    shodan格式  

 标准：

\1. golang实现，协议格式解析不能使用第三方库

\2. 通过命令行传递ip或ip段及端口进行协议识别

\3. 必须能获取到服务端的banner信息，参考shodan的示例结果

\4. 所有log输出开头以[协议名]开始： 比如log.Info("[SMB] user login”)。需要记录协议交互步骤。

## 9月18日（把任务中的所有东西看一遍）

查看shodan中smb协议识别出的内容

![image-20230922145021034](image-20230922145021034.png)

### 文档

https://github.com/hirochachacha/go-smb2

用go实现操作smb2协议

http://e.betheme.net/zz/403861.html?action=onClick

smb协议讲解_SMB协议（使用说明+过程详解+抓包分析）

https://www.xjx100.cn/news/612459.html?action=onClick

SMB详解

https://www.liwenzhou.com/posts/Go/flag/

命令行工具go标准库flag文档

## 9月19日

上午：先和smb协议的ip端口建立连接，没成功，知道smb协议需要在局域网下进行共享文件

下午：smb是局域网下的文件传输所以我无法直接访问公网暴露的IP建立tcp连接
我自己在本地建立另一个Windows用户是在同一局域网下，然后建立连接成功了，然后利用go-smb库实现了获取共享文件列表，但是是调用的第三方库方法。

**了解要下载wareshark和nmap去看这个协议连接的过程**

## 9月20日

早上：下载wareshark尝试去在本地抓包但是失败了，根本获取不到smb协议，然后学习了wareshark的抓包方法和过滤方法

下午：换了一种思路，用nmap去扫描公网上的ip去识别banner信息，然后在linux服务器上下载然后使用之后发现只是识别出了协议，其他啥也没用。然后继续看抓包，试了和其他人连接同一个wifi然后建立连接去抓smb包发现成功抓到了，然后思路变成了自己在linux服务器上装一个软件samba去构造一个smb服务然后自己在本地和他建立通信，研究一下午发现linux服务器和本地不知道怎么连接同一个局域网，这条路放弃了

## 9月21日

早上：请教对面大佬，**发现原来是我自己访问本地没抓到包是选择抓的网卡走错了，不应该监控WLAN而要选择Adapter for local raffic capture  ,然后ip从本机ipv4改为localhost就可以了**

下午：连接成功之后也成功抓到包了，然后学习抓到的数据包分别在那一层然后都有什么用，之后学习了smb协议抓包过程，建立请求的过程，然后模拟整个过程重发数据包，但是在认证的那一步出错了。

## 9月22日

早上：试了用第三方库方法做认证，然后自己只模拟最后一次请求去发数据包获取返回的数据包，还是失败了

下午：请教大佬们，然后发现**不能只重发数据包，需要了解数据包协议中的字段和格式，查看官方文档。**

## 9月25日

早上：提取开源库中利用结构体构造数据包，进行交互去获取共享文件列表

下午：本地局域网测试好了，没有办法试验shodan上的公网ip，请教大佬对比数据包

## 9月26日

上午：测试怎么让在本地连接连接上公网的ip

下午：**把代码部署在服务器上运行，然后能访问公网ip**，成功了



## 实现思路

###  1.建立tcp连接

首先通过TCP三次握手向远程目录PC的445端口发起连接，服务器使用任意空闲端口进行回应

### 2.建立smb协议连接（数据包发送和接收的过程）

a1：客户端向服务器发起请求 `Negotiate Protocol Request (0x00)`，并列出它所支持的所有SMB协议版本

b1:服务器向客户端回应 `Negotiate Protocol Response (0x00)`，并列出希望使用的协议版本。如果没有可使用的协议版本则返回

a2：确定协议后，在用户输入用户名和密码后，客户端进程向服务器发起一个用户或共享的认证：`session setup request`

b2：服务器回应发送一个应答 `Session setup response`数据报来允许或拒绝本次连接。

建立会话的过程可能不止一次的请求/回复的网络包交换，具体的原因是由于**NTLM**认证的过程引起的。

a3：建立会话完成后，客户端发送一个数据报：`Tree connect rerquest SMB`并列出它想访问网络资源的名称或者目录(**IPC$**为空链接)

b3：服务器回应命令：`tree connect response`应答数据报以表示此次连接是否被接受或拒绝

到此连接完成，用户通过可以通过客户端对服务器远程共享目录进行一些操作(上传下载删除等)

### 3.协议解析

1.在第一次negotiate请求的时候根据报文如果是fe534d42就是SMB2如果是ff534d42就是SMB1

2.在身份验证的时候如果默认登录share和123456不成功则就是需要身份验证如果不需要则打印出共享文件列表

# 操作

```
./smb2 -hostname 66.35.63.203 -port 445
```

